<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>ᡠᠨᡨᡠᠨ ᠪᡠᠯᡝᡣᡠ ᠪᡝ ᠠᠰᡥᠠᠮᡝ ᠪᡝ ᡠᠨᡨᡠᡧᡝᠮᡝ降灵ᡪᡞᡥᠠᡞ ᡠᠯᡥᡞᠴᡠᠨ ᠪᡝ ᡠᠰᡝᠮᠪᡞ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="./img/angel.ico">
    <!-- web3 -->
    <script src="./js/web3.min.js"></script>
    <!-- <script language="javascript" type="text/javascript" src="./js/ABI_Bentoken.js"></script>
    <script language="javascript" type="text/javascript" src="./js/ABI_BentoMiner.js"></script> -->
    <script language="javascript" type="text/javascript" src="./js/ABI_Spirit.js"></script>

    <!-- vue.js -->
    <!-- 开发环境版本，包含了有帮助的命令行警告 -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- 生产环境版本，优化了尺寸和速度 -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->
    <!-- css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link type="text/css" rel="styleSheet" href="./css/neon.css" />

    <!-- 强制刷新免遗留 -->
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
    <meta http-equiv="expires" content="0">

</head>
<style scoped>
    body {
        padding: 1vh;
        /* background-image: url("./img/sbpk.jpg"); */
        background-image: url(./img/angel.ico);
        background-repeat: repeat；
    }
</style>

<body>

    <!-- </body> onclick="location.reload();"> -->

    <div id="app" style="width: 100%;">
        <header>
            <div class="card">
                <div class="card-body">
                    <span>
                        <span class="neon" onclick="location.reload();">✝️Spirit👼</span>

                    </span>
                    <span style="float: right;">
                        <a>Total Spirit: {{TotalSpirit}} $Spirit </a><br>
                        <a>BlockHeight:{{blockHeight}}</a>
                    </span>

                </div>
            </div>

        </header>
        <br>
        <nav style="float: none;">
            <div class="card">
                <div class="card-body">
                    $Spirit living in contract @:<a
                        href="https://kovan.etherscan.io/address/0x7d5b228d62cfe50831145Cff0B50Fe7fF14E8a16">{{spiritAddress}}
                    </a>
                    <!-- <hr class="my-4">
                    Mine Field Contract:{{GovHoeTokenName}}:{{minerAddress}}
                    <br />
                    Total Gov locked: {{govTotalLockedF}} {{GovHoeTokenName}} -->
                </div>
            </div>

        </nav>
        <hr>

        <div class="container" style="max-width: 100%;">
            <div class="row">

                <div class="col-8">
                    <!-- $bento -->
                    <section>
                        <div class="card">
                            <div class="card-body">
                                <!-- <h5 class="card-title">$BENTO</h5> -->
                                SpiritNumber now: {{spirit_number}}
                                <hr>
                                <div style="display:inline-block;width: 100%;"><span class="card-text">
                                        {{spirit_blessing}}</span>
                                    <br>
                                    —————— What spirit says.
                                    <!-- <span style="float: right;" class="btn btn-warning" @click='claimBento()'>Claim
                                        All</span></div> -->
                                    <!-- <hr>
                                <div style="display:inline-block;width: 100%;"><span class="card-text">My $BENTO in
                                        Bank:{{bento_inBank}}</span>
                                    <span style="float: right;" class="btn btn-danger"
                                        @click='withdrawBento()'>Withdraw</span>

                                    <input class="input-group-text" style="width: 25%;display: inline-flex; float:right"
                                        type="number" placeholder='Amount' v-model='v_Bentos_withdraw'></input></div> -->

                                </div>
                            </div>
                    </section>
                    <hr>
                    <!-- $gov -->
                    <section>
                        <div class="card">
                            <div class="card-body">
                                <!-- <span style="width: 30%;" class='card-title'>{{GovHoeTokenName}}</span> -->
                                <!-- Balance : {{gov_balance}} {{GovHoeTokenName}} in wallet
                                <span style="float: right;" type="button" class="btn btn-success"
                                    @click="approveGovToken()">Approve</span>
                                <hr> -->
                                <div style="display:inline-block;width: 100%;"><span class="card-text"> Create Spirit
                                        {{gov_lockedF}} {{GovHoeTokenName}}</span>
                                    <!-- <span style="float: right;" class="btn btn-primary"
                                        @click='depositGovTokenToMine()'>Deposit to mine</span> -->

                                </div>
                                <hr>
                                <div style="display:inline-block;width: 100%;">
                                    <input class="input-group-text"
                                        style="width: 100%;display: inline-flex;margin-bottom: 5px;" type="number"
                                        placeholder='Spirit Number' v-model='newSpirit_Number'></input>
                                    <br>
                                    <input class="input-group-text"
                                        style="width: 100%;display: inline-flex;margin-bottom: 5px;" type="text"
                                        placeholder='Blessing' v-model='newSpirit_Blessing'></input>
                                    <br>
                                    <span style="float: right;" class="btn btn-success"
                                        @click='createSpirit()'>Summon</span>
                                </div>
                                <hr>
                                You can see this because you are a summoner.
                            </div>
                        </div>
                    </section>
                </div>
                <div class="col-4">
                    <aside>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Events</h5>
                                <p class="card-text">这里用来显示每一个灵的降生。
                                </p>
                                <a href="#" class="btn btn-info">手动刷新</a>
                            </div>
                        </div>
                    </aside>

                </div>
            </div>

        </div>

</body>
<script>
    var SpiritAddress = "0xAcAcBa641166615732B70EDBa0f84DAef89677b7";
    var firstContractHigh = 21454192;
    // self.setTimeout("app.RefreshFunds()", 1000);
    self.setInterval("app.getMySpiritNumber()", 10000);
    console.log('SpiritAddress:', SpiritAddress);

    var lg = 'en';
    //TODO:测试web3是metamask的还是我导入的
    // web3js = new Web3(web3.currentProvider);
    web3js = new Web3(web3.currentProvider);
    SpiritContract = new web3js.eth.Contract(Spirit_ABI, SpiritAddress);

    //如果用户安装了MetaMask，必须要求他们授权应用登录并获取其账号才能使用
    ethereum.enable();
    window.ethereum;
    // 成功之后这个会返回当前选择的账户
    web3js.eth.getAccounts().then(function (accounts) {
        //现在只能使用then异步的方式返回单个了
        console.log('Now account:', accounts);
    });
    ethereum.on('accountsChanged', function (accounts) {
        // Time to reload your interface with accounts[0]!
        //   app.RefreshFunds();
        //   app.myGameDatas = [];
        //   app.lobbyGameDatas = [];
    })
    var STORAGE_KEY = 'Spirit';
    var DApp_Storage = {
        fetch: function () {
            //整个取
            var games = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            // 如果取不到就返回[]
            // games.forEach(function (game, index) {
            //   game.id = index
            // });
            // xxxStorage.uid = games.length; //这里是unitID的意思，单个item的ID
            return games
        },
        save: function (games) {
            //整个存
            localStorage.setItem(STORAGE_KEY, JSON.stringify(games))
        }
    };

    var app = new Vue({
        el: '#app',
        data: function () {
            return {
                spiritAddress: SpiritAddress,
                w3: web3js = new Web3(web3.currentProvider),
                addressNow: '0x0000000000000000000000000000000000000000',
                localDatas: DApp_Storage.fetch(),
                //宏观数据
                TotalSpirit: 0,
                SpiritComingEvents: '',
                // govTotalLocked: 0,
                // govTotalLockedF: 0,
                blockHeight: 0,
                // poolWeight: 0,
                // totalPoolWeight: 0,
                // GovHoeTokenName: '$NAP',
                // //个人数据
                spirit_number: 0,
                spirit_blessing: 'Not being blesse.',
                // bento_MiningSpeed: 0,
                // bento_unclaim: 0,
                // bento_inBank: 0,
                // gov_balance: 0,
                // gov_locked: 0,
                newSpirit_Number: '',
                newSpirit_Blessing: ''
                // gov_lockedF: 0,
                // gov_percentage: 0,
                // //交互数据
                // v_Govs_deposit: null,
                // v_Govs_withdraw: null,
                // v_Bentos_withdraw: null
            }
        },
        //声明周期
        beforeCreat() {

        },
        Created() {

        },
        beforeMount() {

        },
        mounted() {
            this.refreshAll();
        },
        beforeUpdate() {

        },
        updated() {
            this.delyRefresh();
        },
        beforeDestory() {

        },
        destoryed() {

        },
        //方法
        methods: {
            // // 国际化
            // // internationalization(_lg) {
            // //     if (_lg == 'zh') {
            // //         this.title = '{{GovHoeTokenName}} 治理'
            // //     } else if (_lg == 'en') {
            // //         this.title = '{{GovHoeTokenName}} Gov'
            // //     }
            // // },
            // 数据处理方法
            _formatBigNumber(_bn) {
                return web3js.utils.fromWei(_bn, 'ether');
                // return parseFloat(web3js.utils.fromWei(_bn, 'ether')).toLocaleString();
            },
            // // 数据获取方法
            refreshAll() {
                // this.internationalization(lg);
                // this.getBentoTotalSupply();
                this.getTotalSpirit();
                this.getBlockHeight();
                // this.getWeigthInfo();
            },
            delyRefresh() {
                this.getMySpiritNumber();
                this.getMyBlessing();
                // this.getMyBentoInBank();
                // this.getGovBalance();
                // this.getGovLockedAmount();
                // this.getBentoMiningSpeed();
                // this.getMyMiningPercentage()
            },
            getTotalSpirit() {
                SpiritContract.methods.totalSupply().call().then((rst) => {
                    this.TotalSpirit = rst / 1e18;
                    // this.govTotalLockedF = this._formatBigNumber(rst);
                })
            },
            getBlockHeight() {
                web3js.eth.getBlockNumber().then((rst) => { this.blockHeight = rst; console.log(rst) })
            },
            getMySpiritNumber() {
                SpiritContract.methods.balanceOf(web3.eth.defaultAccount).call().then((rst) => {
                    this.spirit_number = this._formatBigNumber(rst);
                    console.log(rst);
                })
            },
            getMyBlessing() {
                SpiritContract.methods.getSpiritByBeingBlessed(web3.eth.defaultAccount).call().then((rst) => {
                    // console.log(rst.blassing)
                    this.spirit_blessing = rst.blassing;

                })
            },
            getPastEventOfSpirit() {
                SpiritContract.getPastEvents('NewSpirit_Coming', { fromBlock: firstContractHigh }).then((rst) => {
                    // console.log(rst) ;
                    SpiritComingEvents = rst;
                });
            },
            createSpirit() {
                if(this.spirit_number != 0){
                    alert('You already have a spirit.')
                    return
                }
                cfm = confirm(`SpiritBlessin：【${this.newSpirit_Blessing}】
                SpiritNumber：【${this.newSpirit_Number}】
                Sure to submit?`)
                if (cfm) {
                    SpiritContract.methods.createSpirit(this.newSpirit_Blessing, this.newSpirit_Number).send({ from: web3.eth.defaultAccount }).then((rst) => {
                        console.log(rst);
                    })
                }

            }


        }
    })
    // TODO:更新为accounts[i]


</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>



</html>